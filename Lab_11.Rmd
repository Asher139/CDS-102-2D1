---
title: "Lab 11: Databases"
author: "MinJae Jo"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    highlight: tango
    toc: false
    df_print: kable
    fig_caption: no
    number_sections: no
    dev: pdf
geometry: margin=1in
fontsize: 11pt
documentclass: article
---

```{r setup, include = FALSE}
# DO NOT ALTER THIS CHUNK
knitr::opts_chunk$set(
  echo = TRUE,
  eval = TRUE,
  fig.width = 5,
  fig.asp = 0.618,
  out.width = "70%",
  dpi = 120,
  fig.align = "center",
  cache = FALSE
)

suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(dbplyr))
suppressPackageStartupMessages(library(RSQLite))
if(file.exists("nycflights13.sqlite") == FALSE){
  dbplyr::nycflights13_sqlite(path = ".")
}
```


## Lab report

### Exercise 1
```{r}
library(DBI)
library(RSQLite)
library(dbplyr)

con <- dbConnect(SQLite(), "nycflights13.sqlite")
```


### Exercise 2
```{r}
library(dbplyr)
flights_tbl <- tbl(con, "flights")
```

### Exercise 3
```{r}
flights_query <- flights_tbl %>%
  select(year, month, day, hour, dep_delay, origin)
```

### Exercise 4
```{r,echo=FALSE}
show_query(flights_query)
```

### Exercise 5
```{r}
flights_df <- flights_query %>%
  collect()
```

### Exercise 6
```{r, echo=FALSE}
library(ggplot2)
ggplot(flights_df, aes(x = dep_delay)) +
  geom_histogram(binwidth = 5, color = "white") +
  labs(title = "Distribution of Departure Delays",
       x = "Departure Delay (minutes)",
       y = "Count")
```
- The average is much higher than the median, meaning there are many very long delays that drive the average up. While most flights don't experience significant delays, some have very long delays.

### Exercise 7
i. Each row represents a weather observation record of a specific date and time at an airport in one of the JFK/LGA/EWRs.

ii. The precip column contains information related to rain or precipitation.

iii. The origin column indicates at which airport (JFK, LGA, EWR) the meteorological measurements were made.


### Exercise 8
```{r, echo=FALSE}
weather_tbl <- tbl(con, "weather")

weather_query <- weather_tbl %>%
  select(origin, year, month, day, hour, temp, wind_speed, precip)

show_query(weather_query)
```


### Exercise 9
```{r, echo=FALSE}
joined_query <- flights_query %>%
  left_join(weather_query,
            by = c("origin", "year", "month", "day", "hour"))

show_query(joined_query)
```


### Exercise 10
```{r, echo=FALSE}
joined_query <- flights_query %>%
  left_join(weather_query,
            by = c("origin", "year", "month", "day", "hour"))

```
- Each row shows one flight with weather conditions at sa airport.

```{r}
joined_df <- joined_query %>% collect()
```
### Exercise 11
```{r, echo=FALSE, warning=FALSE}
library(ggplot2)

# Scatter plot 1: dep_delay vs precip
ggplot(joined_df, aes(x = precip, y = dep_delay)) +
  geom_point(alpha = 0.3) +
  labs(
    title = "Departure Delay vs Precipitation",
    x = "Precipitation (mm)",
    y = "Departure Delay (minutes)"
  )

# Scatter plot 2: dep_delay vs wind_speed
ggplot(joined_df, aes(x = wind_speed, y = dep_delay)) +
  geom_point(alpha = 0.3) +
  labs(
    title = "Departure Delay vs Wind Speed",
    x = "Wind Speed",
    y = "Departure Delay (minutes)"
  )
```
-As it rains more, dep_delay tends to increase slightly. However, it is not a very strong correlation because the dots are spread out. Wind_speed seems to have little apparent relationship with delay.
### Exercise 12
- When I looked at the two scatterplots, the correlation between bad weather and delay in departure did not seem very strong. There were a few times when the delay was longer when it was raining heavily or windy, but most of the points were scattered without any obvious shape. Therefore, the overall pattern appeared weaker than expected. But on more thought, this dataset only includes flights that actually left. Flights canceled due to bad weather are not included in the data at all. This creates a kind of survival bias, as it only analyzes flights that "survived" from bad weather. Including canceled flights, the impact of bad weather on delays would seem greater. Therefore, the weak pattern in the graph may be due to the worst cases not appearing in the dataset at all.
